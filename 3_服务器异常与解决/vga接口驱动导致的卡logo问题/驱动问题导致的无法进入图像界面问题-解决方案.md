
## **超微服务器开机卡 Logo 问题排查与解决文档**

### 1. 问题现象

* 设备：Supermicro 主板 + 双 RTX 4090 + Ubuntu 22.04（系统安装在 NVMe 固态硬盘上）
* 新增硬件：在 `/mnt` 挂载目录下新加了一块机械硬盘（数据盘）
* 问题表现：

  1. 开机停留在 **Supermicro + Ubuntu Logo** 界面，不进入图形登录界面；
  2. 使用 `Ctrl+Alt+F2` 可进入 TTY 文本终端，并正常登录系统；
  3. NVIDIA 驱动加载正常（`nvidia-smi` 可识别两张显卡）；
  4. 系统日志 `/var/log/Xorg.0.log` 中出现 `failed to load module "ast"` 报错；
  5. `gdm3` 状态为 active(running)，但图形界面未能启动。

---

### 2. 原因分析

#### 2.1 背景

* Supermicro 主板通常内置 **BMC 管理芯片（ASPEED AST 系列）** 提供 VGA 输出。
* 当显示器接在主板 VGA 口时，Xorg 图形服务器会优先尝试加载 **`ast` 驱动** 或 **modesetting 驱动** 来驱动输出。
* NVIDIA 驱动主要负责 GPU 加速与 CUDA 计算，不直接参与 VGA 输出。

#### 2.2 问题根源

* 系统启动时，Xorg 被配置为优先使用 `ast` 驱动输出，但系统中缺少 `xserver-xorg-video-ast` 模块文件（或模块不可用）；
* 导致 Xorg 图形服务器在初始化阶段报错，gdm3 虽然运行，但图形会话无法建立 → 停留在 Logo 界面。

#### 2.3 为什么 NVIDIA 驱动没报错？

* `nvidia-smi` 正常是因为 NVIDIA 内核模块加载成功，CUDA 计算可用；
* 但 Xorg 没有把显示绑定到 NVIDIA 输出口，而是试图走主板 VGA（AST），因此 NVIDIA 驱动的图形输出功能没有被调用。

---

### 3. 解决思路

#### 3.1 思路分析

* **方案 1（推荐）**：直接让 Xorg 使用内核自带的 **modesetting 驱动** 进行 VGA 输出（绕过 `ast` 模块），避免缺失驱动包的依赖问题，同时保留 NVIDIA 驱动仅做计算。
* **方案 2**：安装 `xserver-xorg-video-ast` 包，让 Xorg 继续使用 AST 专用驱动。

#### 3.2 选择理由

* modesetting 是 Xorg 的通用输出驱动，依赖极少，与内核 DRM 模块协作稳定；
* NVIDIA 驱动与 modesetting 驱动可以同时存在，互不干扰：桌面走 VGA/modesetting，计算走 GPU。

---

### 4. 解决步骤（方案一）

#### 4.1 禁用 Wayland

```bash
sudo sed -i 's/^#WaylandEnable=false/WaylandEnable=false/' /etc/gdm3/custom.conf
```

#### 4.2 创建 Xorg 配置文件，强制使用 modesetting

```bash
sudo mkdir -p /etc/X11/xorg.conf.d
sudo tee /etc/X11/xorg.conf.d/10-vga-modesetting.conf >/dev/null <<'EOF'
Section "Device"
    Identifier "Builtin VGA via modesetting"
    Driver "modesetting"
EndSection
EOF
```

#### 4.3 移除可能干扰的旧 Xorg 配置

```bash
sudo [ -f /etc/X11/xorg.conf ] && sudo mv /etc/X11/xorg.conf /etc/X11/xorg.conf.bak
```

#### 4.4 确认 aspeed DRM 模块已加载（非必须）

```bash
lsmod | grep aspeed || sudo modprobe aspeed
```

#### 4.5 重启显示管理器

```bash
sudo systemctl restart gdm3
```

按 `Ctrl+Alt+F1`（或 `Ctrl+Alt+F7`）返回图形界面，确认是否恢复。

---

### 5. 验证结果

* 图形登录界面成功显示；
* `nvidia-smi` 仍能正常识别双 4090，CUDA 计算功能不受影响；
* `/var/log/Xorg.0.log` 中已无 `failed to load module ast` 报错；
* 系统重启后图形界面可正常进入，问题彻底解决。

---

### 6. 经验总结

1. **服务器 VGA 输出不等于 NVIDIA 输出**
   主板 VGA 口通常由 BMC/AST 驱动，不经过 GPU 输出通道。
2. **驱动缺失会导致 Xorg 启动失败**
   即便 gdm3 状态正常，Xorg 若找不到对应显示驱动模块，仍会卡在 Logo。
3. **分离显示与计算是稳妥方案**
   让桌面走 modesetting，GPU 专注 CUDA，可以避免驱动冲突，尤其在服务器/远程管理场景。
4. **TTY 是排障利器**
   在 Logo 卡住时，`Ctrl+Alt+F2` 进入 TTY，可以查日志、改配置、重启服务。

------
解决方案本质上就是**绕过损坏/缺失的 AST 专用驱动，改用通用的 modesetting 驱动来启动 Xorg**。

具体来说：

* **原情况**

  * Supermicro 主板上的 VGA 接口走的是 ASPEED AST BMC 芯片。
  * Ubuntu 的 Xorg 默认会尝试加载 `ast` 模块（`xserver-xorg-video-ast` 提供）。
  * 这个模块在系统中要么缺失、要么版本不兼容，导致 GDM3 在启动时加载失败（`failed to load module "ast"`），结果停在 Logo 界面。

* **采取的方案**

  1. 编辑 Xorg 配置文件（或添加新的配置），指定**不再使用 `ast` 驱动**，而是用内置的**modesetting**驱动：

     ```bash
     sudo nano /etc/X11/xorg.conf.d/10-vga.conf
     ```

     内容：

     ```conf
     Section "Device"
         Identifier "Builtin VGA"
         Driver "modesetting"
     EndSection
     ```
  2. 保存并重启。
  3. modesetting 驱动由 Xorg 自带，不依赖外部 AST 驱动，因此成功启动了图形界面。

* **效果**

  * 图形界面正常启动，GDM3 登录可用。
  * 绕过了 AST 驱动加载过程，从而避免卡死。

📌 **总结**
这是典型的“驱动加载失败 → 图形界面卡死”问题，解决方案是**用稳定的通用驱动替代专用驱动**，属于绕过而不是修复 AST 驱动本身。
如果将来需要 VGA 输出的完整硬件加速功能，可能还需要重新安装或更新 `xserver-xorg-video-ast` 包，但在服务器场景下（大概率用 4090 做计算，不依赖 VGA 性能），modesetting 已经足够稳定。
