# **超微服务器 Ubuntu 卡 Logo 故障全流程排查记录**

## 流程总览

### 0. 背景信息

* **硬件**：Supermicro 主板 + 双 RTX 4090 + Ubuntu 22.04（系统盘为 NVMe 固态）
* **新加硬件**：第二块机械硬盘（数据盘），挂载到 `/mnt`
* **事件触发**：加装新机械硬盘后首次重启

---

## 1. 现象描述

* 开机停留在 **Supermicro + Ubuntu Logo** 界面，无进一步进展；
* 无法直接进入 TTY（`Ctrl+Alt+F2` 一度无响应，仅闪烁光标）；
* 远程桌面无法连接（由于 IP 变化且无法查询）；
* 偶尔 BIOS 报错：

  ```
  Failing DIMM: DIMM location. (uncorrectable memory component found) P1-DIMMC1
  Incorrect memory DIMM population P1-DIMMC1
  ```

---

## 2. 排查过程

| 时间     | 现象                        | 怀疑原因                                                   | 排查操作                                   | 结果                       |
| ------ | ------------------------- | ------------------------------------------------------ | -------------------------------------- | ------------------------ |
| **T0** | BIOS 提示内存错误（C1 槽），Logo 卡死 | 内存条损坏或插槽问题                                             | 多轮交换/拔除内存条，记录 BIOS 变化                  | 换插后，错误随内存条移动，确认至少有两条内存损坏 |
| **T1** | 去掉损坏条后仍卡 Logo             | 其他内存兼容性或插槽顺序问题                                         | 按说明书推荐插槽顺序重新安装剩余内存（A1-E1-C1-G1）        | BIOS 识别异常（部分插槽不显示内存）     |
| **T2** | 怀疑新机械硬盘影响启动               | 检查 `/etc/fstab`，尝试临时注释数据盘挂载                            | Emergency Mode 情况消失，但 Logo 卡顿依旧        |                          |
| **T3** | 尝试进入 TTY                  | `Ctrl+Alt+F2` 最初无显示，后成功进入 TTY2                         | 可以登录 shell，但无图形界面                      |                          |
| **T4** | 检查图形服务                    | `systemctl status gdm3` 显示运行中，但桌面未加载                   | 锁定为 Xorg 图形初始化失败                       |                          |
| **T5** | 检查 Xorg 日志                | `/var/log/Xorg.0.log` 出现 `failed to load module "ast"` | 确认系统缺少 `xserver-xorg-video-ast` 或驱动不可用 |                          |
| **T6** | 判断显示输出路径                  | 服务器 VGA 接口走 AST 芯片，非 NVIDIA 输出                         | 决定改用通用 `modesetting` 驱动替代 AST          |                          |

---

## 3. 最终解决方案

**目标**：绕过缺失的 `ast` 驱动，使用 Xorg 通用输出驱动 `modesetting`。

1. **禁用 Wayland**

   ```bash
   sudo sed -i 's/^#WaylandEnable=false/WaylandEnable=false/' /etc/gdm3/custom.conf
   ```

2. **创建 Xorg 配置**

   ```bash
   sudo mkdir -p /etc/X11/xorg.conf.d
   sudo tee /etc/X11/xorg.conf.d/10-vga-modesetting.conf >/dev/null <<'EOF'
   Section "Device"
       Identifier "Builtin VGA via modesetting"
       Driver "modesetting"
   EndSection
   EOF
   ```

3. **移除可能冲突的全局 Xorg 配置**

   ```bash
   sudo [ -f /etc/X11/xorg.conf ] && sudo mv /etc/X11/xorg.conf /etc/X11/xorg.conf.bak
   ```

4. **重启显示管理器**

   ```bash
   sudo systemctl restart gdm3
   ```

   按 `Ctrl+Alt+F1` 返回图形界面。

---

## 4. 验证结果

* 系统正常进入图形登录界面；
* `nvidia-smi` 正常识别双 4090，CUDA 运算可用；
* `/var/log/Xorg.0.log` 中不再出现 `failed to load module "ast"`；
* 多次重启验证通过。

---

## 5. 经验总结与建议

1. **多层次排查**

   * **硬件层**：先排查内存、硬盘等物理故障，防止硬件错误干扰后续判断；
   * **系统层**：检查挂载、启动项配置是否导致 Emergency Mode；
   * **服务层**：确认图形管理器（gdm3/lightdm）和 Xorg 是否正常。

2. **区分计算与显示路径**
   服务器 VGA 输出不走 NVIDIA 驱动，驱动缺失不会影响 CUDA 计算，但会影响桌面显示。

3. **TTY 是救命稻草**
   在图形界面不可用时，`Ctrl+Alt+F2/F3...` 进入 TTY，结合 `journalctl` 和 `/var/log/Xorg.0.log` 能快速定位问题。

4. **驱动兼容优先性**
   在服务器环境中，建议桌面使用通用驱动（modesetting），NVIDIA 驱动只负责计算，减少冲突风险。

## 流程细节 -- Supermicro 双 RTX 4090 服务器卡 Logo 故障排查技术手册

### 1. 问题概述

**问题现象**
服务器在开机时卡在带有 *Ubuntu* 与 *Supermicro* Logo 的画面，无法进入图形界面，也无法在本地直接看到登录界面。
此前该服务器可正常运行 Ubuntu 22.04，且两张 RTX 4090 与存储设备工作正常。
问题从加装第二块机械硬盘（均挂载在 `/mnt` 下）后开始出现。

**业务影响**

* 无法通过本地显示器访问系统图形界面
* 若局域网 IP 变更，则无法通过远程桌面连接
* 需要通过其他方式进入系统排查

---

### 2. 排查思路与过程

#### 步骤 1：硬件层排查（内存）

* **怀疑**：服务器 BIOS 在自检时出现 *Failing DIMM* 与 *Incorrect memory DIMM population* 报错，可能导致开机异常。
* **措施**：

  1. 逐条拔插内存，观察报错是否随内存条移动而变化。
  2. 移除报错位置的内存条，仅保留无报错的条进行启动。
* **结果**：

  * 移除故障条后，BIOS 报错消失，但卡 Logo 现象依旧存在 → 内存问题排除。

---

#### 步骤 2：存储层排查（机械硬盘挂载）

* **怀疑**：新增机械硬盘后，`/etc/fstab` 挂载配置错误，导致启动过程阻塞。
* **措施**：

  1. 从 BIOS 中移除机械硬盘或暂时注释 `/etc/fstab` 中的挂载条目。
  2. 尝试仅连接系统 NVMe 硬盘启动。
* **结果**：

  * 移除机械硬盘后可能进入 *emergency mode*，仍无法正常进入图形界面 → 存储挂载问题排除。

---

#### 步骤 3：进入 TTY 进行软件层排查

* **操作**：

  * 在卡 Logo 界面使用 `Ctrl + Alt + F2` 进入 TTY2 终端，并成功以账户登录。
* **观察**：

  * `systemctl status gdm3` 显示 GDM3 正在运行。
  * 查看 `/var/log/Xorg.0.log` 发现报错：

    ```
    failed to load module "ast" (module does not exist, 0)
    ```

    其中 **AST** 为 Supermicro 主板 BMC 芯片的 VGA 专用驱动。

---

### 3. 根因分析

* Supermicro 主板的 VGA 接口使用 **ASPEED AST** 芯片进行视频输出。
* Ubuntu 桌面启动时，Xorg 会尝试加载 `xserver-xorg-video-ast` 模块。
* 该驱动在系统中缺失、版本不兼容或损坏，导致 Xorg 初始化 VGA 显示失败。
* GDM3 虽然运行，但因 Xorg 启动失败而无法切换到图形界面 → 系统停留在 Logo 界面。

---

### 4. 解决方案

**绕过 AST 驱动，使用通用 `modesetting` 驱动启动 Xorg**

1. 创建或编辑配置文件：

   ```bash
   sudo mkdir -p /etc/X11/xorg.conf.d
   sudo nano /etc/X11/xorg.conf.d/10-vga.conf
   ```
2. 写入内容：

   ```conf
   Section "Device"
       Identifier "Builtin VGA"
       Driver "modesetting"
   EndSection
   ```
3. 保存退出并重启：

   ```bash
   sudo reboot
   ```
4. 系统将使用 Xorg 内置的通用驱动启动图形界面，绕过 AST 驱动加载失败的问题。

---

### 5. 结果与验证

* 服务器重启后可正常进入 Ubuntu 图形界面。
* 两张 RTX 4090 在 `nvidia-smi` 中正常识别，计算功能正常。
* VGA 输出正常显示桌面，无需安装 AST 专用驱动。

---

### 6. 预防建议

1. **驱动管理**

   * 若必须使用 VGA 接口，建议保留并更新 `xserver-xorg-video-ast` 驱动，以防后续依赖。
   * 对 GPU 服务器而言，如无特殊需求，modesetting 足以支持基本显示。

2. **系统更新**

   * 系统升级时注意显卡及显示驱动的兼容性，避免被覆盖或移除。

3. **硬件更换流程**

   * 加装硬盘、内存等硬件前，建议先记录 BIOS 配置与系统挂载点，逐步加装并测试，避免同时引入多个变量。
